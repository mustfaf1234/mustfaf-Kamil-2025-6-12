<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم المشرف</title>
  <style>
    body {
      font-family: Arial;
      background-color: #f8f8f8;
      padding: 10px;
      margin: 0;
    }

    h2 {
      text-align: center;
      color: #004080;
    }

    .summary {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .summary h3 {
      margin-top: 0;
    }

    .flight-details {
      background: #e9f1ff;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 5px;
    }

    button {
      background-color: #004080;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: block;
      margin: 15px auto;
    }
  </style>
</head>
<body>

<h2>📊 لوحة المشرف - إحصائيات الرحلات</h2>

<div id="adminContent"></div>
<button onclick="downloadPDF()">تصدير PDF</button>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqOK8dAsYVd3G5kv6rFbrkDfLhmgFOXAU",
    authDomain: "flight-scheduler-3daea.firebaseapp.com",
    projectId: "flight-scheduler-3daea",
    storageBucket: "flight-scheduler-3daea.appspot.com",
    messagingSenderId: "1036581965112",
    appId: "1:1036581965112:web:0bd21e436764ea4294c5cd"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const adminEmail = "ahmedaltalqani@gmail.com";

  onAuthStateChanged(auth, async (user) => {
    if (!user || user.email !== adminEmail) {
      alert("🚫 هذه الصفحة مخصصة للمشرف فقط.");
      window.location.href = "index.html";
      return;
    }

    const snapshot = await getDocs(collection(db, "flights"));
    const flights = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      flights.push(data);
    });

    const summary = {};

    flights.forEach(flight => {
      const user = flight.createdBy || "غير معروف";
      const date = flight.date || "";
      const month = date.split("-").slice(0,2).join("-");
      if (!summary[month]) summary[month] = {};
      if (!summary[month][user]) summary[month][user] = { count: 0, details: [] };
      summary[month][user].count++;
      summary[month][user].details.push(flight);
    });

    const container = document.getElementById("adminContent");
    for (let month in summary) {
      const box = document.createElement("div");
      box.className = "summary";
      box.innerHTML = `<h3>📅 ${month}</h3>`;

      for (let user in summary[month]) {
        const section = document.createElement("div");
        section.innerHTML = `<strong>${user}:</strong> ${summary[month][user].count} رحلة`;

        summary[month][user].details.forEach((flight, index) => {
          const detail = document.createElement("div");
          detail.className = "flight-details";
          detail.textContent = `${index + 1}. FLT.NO: ${flight.flightNo || ""}, التاريخ: ${flight.date || ""}, الاسم: ${flight.name || ""}`;
          section.appendChild(detail);
        });

        box.appendChild(section);
      }

      container.appendChild(box);
    }
  });

  window.downloadPDF = function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    const content = document.getElementById("adminContent").innerText.split('\n');
    content.forEach(line => {
      if (y > 270) {
        doc.addPage();
        y = 10;
      }
      doc.text(line, 10, y);
      y += 6;
    });

    doc.save("report.pdf");
  };
</script>

</body>
</html>